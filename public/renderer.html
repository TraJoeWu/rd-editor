<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="./output/css/output.css">
    <style lang="">
        #RDEditor {
            padding: 5px;
        }
    </style>
</head>

<body>
    <div class="container output">
        <div id="RDPageHeader"></div>
        <div id="RDEditor" class="editable-area"></div>
        <div id="RDAnchorNav"></div>
    </div>
</body>
<script>
    var data = {
        header: {
            title: '学院介绍',
            author: 'joe.wu',
            location: '四川省',
            date: '2017-09-28'
        },
        content: {
            "id": "1",
            "cells": [
                {
                    "id": "64f0bbcd-81dd-42f8-b142-c7118c4fc84f",
                    "inline": null,
                    "size": 12,
                    "rows": [
                        {
                            "id": "d8464736-8ed4-4784-904d-262d42547d0f",
                            "cells": [
                                {
                                    "id": "262c900c-17e0-4088-8e4a-36ca2cbb2e4f",
                                    "inline": null,
                                    "size": 12,
                                    "content": {
                                        "plugin": {
                                            "name": "AnchorTitle",
                                            "version": "0.0.1"
                                        },
                                        "state": {
                                            "value": "学院介绍",
                                            "id": "anchor-7CTmjl"
                                        }
                                    }
                                }
                            ]
                        },
                        {
                            "id": "528262d0-924c-4695-98a1-47fc72653d57",
                            "cells": [
                                {
                                    "id": "5264b054-014a-4e1a-b616-c73eefd28d11",
                                    "inline": null,
                                    "size": 7,
                                    "content": {
                                        "plugin": {
                                            "name": "slate",
                                            "version": "0.0.1"
                                        },
                                        "state": {
                                            "serialized": {
                                                "nodes": [
                                                    {
                                                        "kind": "block",
                                                        "type": "PARAGRAPH/PARAGRAPH",
                                                        "nodes": [
                                                            {
                                                                "kind": "text",
                                                                "text": "        井冈山青年干部学院是以理想、信念和团队执行力建设为宗旨的，用“井冈山精神”对各党政机关、大中专院校和企事业单位的青年骨干进行团队执行力建设的专业社会培训机构。学院教职工60余人，是井冈山红色培训机构最完整、规模最大的培训学院之一。\r"
                                                            }
                                                        ]
                                                    },
                                                    {
                                                        "kind": "block",
                                                        "type": "PARAGRAPH/PARAGRAPH",
                                                        "nodes": [
                                                            {
                                                                "kind": "text",
                                                                "text": "        学院创办于2010年，时为井冈山市青年干部培训中心。2016年7月经市政府批准，升格为井冈山青年干部学院，成立6年来，培训学员近10万人（50万人次）。"
                                                            }
                                                        ],
                                                        "data": {
                                                            "align": "left"
                                                        }
                                                    },
                                                    {
                                                        "kind": "block",
                                                        "type": "PARAGRAPH/PARAGRAPH",
                                                        "nodes": [
                                                            {
                                                                "kind": "text",
                                                                "text": "        学院位于风景秀美的井冈山核心旅游区---茨坪镇长坑路11号，占地20余亩，建筑面积7600平方米。学院下设教研室、办公室、对外合作处、井冈山精神研究院、青干培训中心、电教馆、会议室、客房和餐厅等部门和分支机构。与全国各地100多所党校、大学和企业等培训机构有密切合作。基地按四星标准设计和装修，共有各类学员宿舍70余间，一次性可容纳200多名学员学习。"
                                                            }
                                                        ],
                                                        "data": {
                                                            "align": "left"
                                                        }
                                                    }
                                                ]
                                            }
                                        }
                                    }
                                },
                                {
                                    "id": "7cb4616d-430d-4060-b7e3-73da32bbe193",
                                    "inline": null,
                                    "size": 5,
                                    "content": {
                                        "plugin": {
                                            "name": "image",
                                            "version": "0.0.1"
                                        },
                                        "state": {
                                            "src": "http://www.renda1j.com/Content/images/Home/training_01.jpg"
                                        }
                                    }
                                }
                            ]
                        },
                        {
                            "id": "2cde510c-9d84-4b38-a9e2-113c44879ea8",
                            "cells": [
                                {
                                    "id": "abd54d61-4088-427d-874f-df07c3b5f976",
                                    "inline": null,
                                    "size": 12,
                                    "content": {
                                        "plugin": {
                                            "name": "AnchorTitle",
                                            "version": "0.0.1"
                                        },
                                        "state": {
                                            "value": "培训模式",
                                            "id": "anchor-aAJN4w"
                                        }
                                    }
                                }
                            ]
                        },
                        {
                            "id": "4d2ed920-ee4b-4ef5-b20c-ba33ca0f794d",
                            "cells": [
                                {
                                    "id": "e5df07f7-ea02-4406-a812-fa2480e1222c",
                                    "inline": null,
                                    "size": 12,
                                    "content": {
                                        "plugin": {
                                            "name": "slate",
                                            "version": "0.0.1"
                                        },
                                        "state": {
                                            "serialized": {
                                                "nodes": [
                                                    {
                                                        "kind": "block",
                                                        "type": "LISTS/LIST-ITEM",
                                                        "nodes": [
                                                            {
                                                                "kind": "text",
                                                                "text": "专题教学"
                                                            }
                                                        ]
                                                    }
                                                ]
                                            }
                                        }
                                    }
                                }
                            ]
                        },
                        {
                            "id": "423f9f88-136e-406f-b95c-91efeef90944",
                            "cells": [
                                {
                                    "id": "fe03a45c-0f13-4b4b-b40e-0733a03a7f21",
                                    "inline": null,
                                    "size": 12,
                                    "content": {
                                        "plugin": {
                                            "name": "image",
                                            "version": "0.0.1"
                                        },
                                        "state": {
                                            "src": "http://www.renda1j.com/Content/images/Home/training_05.jpg"
                                        }
                                    }
                                }
                            ]
                        },
                        {
                            "id": "4c0ca31e-d41c-424a-b0b4-5443af1b78f9",
                            "cells": [
                                {
                                    "id": "5f8b2068-ce3a-4739-9deb-2defe12d3c0d",
                                    "inline": null,
                                    "size": 12,
                                    "content": {
                                        "plugin": {
                                            "name": "slate",
                                            "version": "0.0.1"
                                        },
                                        "state": {
                                            "serialized": {
                                                "nodes": [
                                                    {
                                                        "kind": "block",
                                                        "type": "PARAGRAPH/PARAGRAPH",
                                                        "nodes": [
                                                            {
                                                                "kind": "text",
                                                                "text": "【以理论指导实践，达到思想的升华】\r"
                                                            }
                                                        ]
                                                    },
                                                    {
                                                        "kind": "block",
                                                        "type": "PARAGRAPH/PARAGRAPH",
                                                        "nodes": [
                                                            {
                                                                "kind": "text",
                                                                "text": "井冈山精神、井冈山斗争史、中中央苏区斗争史、党性修养、领导科学与艺术、贯彻落实科学发展观与红色管理等方面的100多个专题教学课程，权威专家团授课，深刻学习井冈山核心精神，领悟毛泽东的领军之道。"
                                                            }
                                                        ]
                                                    }
                                                ]
                                            }
                                        }
                                    }
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    }

</script>
<script>
    function RDEditorRenderer(data) {
        this.data = data
        this.content = this.data.content
        this.header = this.data.header
        this.classes = {
            row: 'ory-row',
            cell: 'ory-cell',
            cellInner: 'ory-cell-inner',
            cellleaf: 'ory-cell-leaf',
            pluginImage: 'ory-plugins-content-image'
        }
        this.headerHtml = ''
        this.contentHtml = ''
        this.anchorNavHtml = ''
        this.anchorNavData = []
        this.init()
    }

    RDEditorRenderer.prototype = {
        init: function () {
            this.headerHtml = this.getHeaderHtml()
            this.contentHtml = this.getContentHtml()
            this.anchorNavHtml = this.getAnchorNavHtml()
            this.render()
            this.bind()
            this.resize()
        },
        bind: function () {
            var self = this,
                containerTop = document.querySelector('.container').offsetTop,
                pageHeaderHeight = document.getElementById('RDPageHeader').offsetHeight,
                interval

            var scroll = function () {
                var scrollTop = window.scrollY,
                    titleEl = document.querySelectorAll('.anchor-title')

                for (var i = titleEl.length - 1; i >= 0; i--) {
                    var item = titleEl[i]

                    var itemTop = item.offsetTop,
                        top = self.getElementTop(item),
                        name = item.getAttribute('name'),
                        nav = document.querySelector('.anchor-nav')

                    if (scrollTop >= top) {
                        var target = nav.querySelector(`li[name="${name}"]`)
                        var navLis = nav.querySelectorAll('li')
                        for (var i = 0; i < navLis.length; i++) {
                            var navLi = navLis[i]
                            navLi.style = null
                        }
                        target.style.background = '#7e57c2'
                        target.style.color = '#fff'
                        break
                    }
                }
            }

            var navigate = function (e) {
                var el = e.target,
                    name = el.getAttribute('name'),
                    targetEl = document.querySelector('.anchor-title[name="' + name + '"]'),
                    // top = (document.documentElement.scrollTop || document.body.scrollTop) + target.getBoundingClientRect().top - 100 + this.containerMargin
                    top = self.getElementTop(targetEl),
                    duration = 1000

                clearInterval(interval)

                interval = setInterval(function () {
                    var sTop = window.scrollY + (top - window.scrollY) / duration * 1000 / 20
                    console.log(sTop, top, window.scrollY)
                    window.scrollTo(0, sTop)
                }, 20)
                setTimeout(function () {
                    clearInterval(interval)
                }, duration)
                // window.Velocity(document.querySelector('html'), 'scroll', { duration: 1000, offset: top + 'px', mobileHA: false })
            }

            window.addEventListener('scroll', scroll)
            this.addEvent(document.querySelectorAll('.anchor-nav-list li'), 'click', navigate)

        },
        getHeaderHtml: function () {
            var header = this.header
            return '<div class="page-header">' +
                '<h1>' + header.title + '</h1>' +
                '<div style="color:#888;">' +
                '<span>作者：' + header.author + '</span>' +
                '<span style="margin-left:5px">' + header.date + '</span>' +
                '<span>' + header.location + '</span>' +
                '</div>' +
                '</div>'
        },
        getContentHtml: function () {
            var self = this,
                contentHtml = '',
                cRow = this.classes.row,
                cCell = this.classes.cell,
                cCellInner = this.classes.cellInner,
                cCellLeaf = this.classes.cellleaf,
                cPluginImage = this.classes.pluginImage

            var cCellGrid = function (size) {
                return cCell + '-sm-' + size + ' ' + cCell + '-xs-' + 12
            }

            var gAnchorTitleHtml = function (state) {
                return '<div class="anchor-title-container">' +
                    '<span class="anchor-title-line"></span>' +
                    '<div class="anchor-title" name="' + state.id + '">' +
                    state.value +
                    '</div>' +
                    '</div>'
            }

            var gSlateHtml = function (state) {
                var html = ''
                !function eachNodes(nodes) {
                    for (var i = 0; i < nodes.length; i++) {
                        var node = nodes[i]
                        if (node.kind === 'block') {
                            var data = node.data
                            html += '<p'
                            if (data && data.align) {
                                html += ' style="text-align:' + data.align + ';"'
                            }
                            html += '>'
                        }
                        if (node.kind === 'text') {
                            html += node.text
                        }
                        if (node.nodes) {
                            eachNodes(node.nodes)
                            html += '</p>'
                        }
                    }
                }(state.serialized.nodes)
                return html
            }

            var gImageHtml = function (state) {
                return '<img class="' + cPluginImage + '" src="' + state.src + '">'
            }

            !function eachCells(cells) {
                for (var i = 0; i < cells.length; i++) {
                    var cell = cells[i]

                    if (cell.cells) {
                        contentHtml += '<div class="' + cRow + ' ' + cCellInner + '">'
                        eachCells(cell.cells)
                        contentHtml += '</div>'
                    }
                    if (cell.rows || cell.size) {
                        contentHtml += '<div class="' + cCell + ' ' + cCellGrid(cell.size) + '">'
                        if (cell.rows) {
                            eachCells(cell.rows)
                            contentHtml += '</div>'
                        }
                    }
                    if (cell.content) {
                        var pluginName = cell.content.plugin && cell.content.plugin.name,
                            state = cell.content.state
                        contentHtml += '<div class="' + cCellInner + ' ' + cCellLeaf + '">'

                        if (pluginName === 'AnchorTitle') {
                            contentHtml += gAnchorTitleHtml(state)
                            self.anchorNavData.push(state)
                        }

                        if (pluginName === 'slate') {
                            contentHtml += gSlateHtml(state)
                        }

                        if (pluginName === 'image') {
                            contentHtml += gImageHtml(state)
                        }

                        contentHtml += '</div>'

                        if (cell.size) {
                            contentHtml += '</div>'
                        }
                    }

                }
            }(this.content.cells)

            return contentHtml
        },
        getAnchorNavHtml: function () {
            var html = '<div class="anchor-nav">' +
                '<ul class="anchor-nav-list">'
            for (var i = 0; i < this.anchorNavData.length; i++) {
                var item = this.anchorNavData[i]
                html += '<li name="' + item.id + '">' + item.value + '</li>'
            }
            html += '</ul>' +
                '</div>'
            return html
        },
        render: function () {
            document.getElementById('RDPageHeader').innerHTML = this.headerHtml
            document.getElementById('RDEditor').innerHTML = this.contentHtml
            document.getElementById('RDAnchorNav').innerHTML = this.anchorNavHtml
        },
        resize: function () {
            var pageHeaderHeight = document.getElementById('RDPageHeader').offsetHeight

            //有锚点菜单并且在平板或手机上浏览
            if (this.anchorNavData.length && document.body.offsetWidth < 800) {
                document.querySelector('.container').style.marginTop = '60px'
            }
        },
        addEvent: function (el, event, handler) {
            if (window.attachEvent) {
                if (el.length > 1) {
                    for (var i = 0; i < el.length; i++) {
                        el.attachEvent(event, handler)
                    }
                }
            } else if (window.addEventListener) {
                if (el.length > 1) {
                    for (var i = 0; i < el.length; i++) {
                        el[i].addEventListener(event, handler, false)
                    }
                }
            }
        },
        getElementTop: function (element) {
            var actualTop = element.offsetTop;
            var current = element.offsetParent;
            while (current !== null) {
                actualTop += current.offsetTop;
                current = current.offsetParent;
            }
            return actualTop;
        }
    }

    new RDEditorRenderer(data)

</script>

</html>